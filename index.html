<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Telegram Web</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        /* (Все стили остаются такими же как в вашем исходном файле) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: #0e1621;
            color: #fff;
            height: 100vh;
            overflow: hidden;
        }

        /* (Все остальные стили остаются без изменений) */
        /* ... остальные стили ... */
        
        /* Скрытые элементы */
        .hidden {
            display: none !important;
        }

        /* Загрузка */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            background: #0e1621;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            z-index: 2000;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #2b5278;
            border-top: 3px solid #0088cc;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- ЭКРАН АВТОРИЗАЦИИ -->
    <div class="auth-screen" id="authScreen">
        <div class="auth-container">
            <div class="auth-tabs">
                <div class="auth-tab active" onclick="showLoginForm()">Вход</div>
                <div class="auth-tab" onclick="showRegisterForm()">Регистрация</div>
            </div>
            
            <form class="auth-form active" id="loginForm" onsubmit="return login(event)">
                <div class="auth-title">Вход в Telegram</div>
                
                <div class="form-group">
                    <label class="form-label">Имя пользователя или Email</label>
                    <input type="text" class="form-input" id="loginUsername" placeholder="tihon или tihon@example.com" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Пароль</label>
                    <input type="password" class="form-input" id="loginPassword" placeholder="●●●●●●" required>
                </div>
                
                <div class="auth-error" id="loginError">Неверный логин или пароль</div>
                
                <button type="submit" class="auth-btn">Войти</button>
            </form>
            
            <form class="auth-form" id="registerForm" onsubmit="return register(event)">
                <div class="auth-title">Регистрация</div>
                
                <div class="form-group">
                    <label class="form-label">Имя пользователя</label>
                    <input type="text" class="form-input" id="registerUsername" placeholder="tihon" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-input" id="registerEmail" placeholder="tihon@example.com" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Имя</label>
                    <input type="text" class="form-input" id="registerName" placeholder="Тихон Метелкин" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Пароль</label>
                    <input type="password" class="form-input" id="registerPassword" placeholder="●●●●●●" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Повторите пароль</label>
                    <input type="password" class="form-input" id="registerPasswordConfirm" placeholder="●●●●●●" required>
                </div>
                
                <div class="auth-error" id="registerError"></div>
                
                <button type="submit" class="auth-btn">Зарегистрироваться</button>
            </form>
        </div>
    </div>

    <!-- ЗАГРУЗКА -->
    <div class="loading hidden" id="loading">
        <div class="spinner"></div>
    </div>

    <!-- ГЛАВНЫЙ КОНТЕЙНЕР -->
    <div class="app-container hidden" id="appContainer">
        <!-- ЛЕВОЕ МЕНЮ -->
        <div class="left-menu">
            <div class="menu-item active" title="Чаты" onclick="showChats()">
                <i class="fas fa-comment-alt"></i>
                <span class="badge" id="unreadBadge">0</span>
            </div>
            <div class="menu-item" title="Каналы" onclick="showChannels()">
                <i class="fas fa-broadcast-tower"></i>
                <span class="badge" id="channelBadge">0</span>
            </div>
            <div class="menu-item" title="Настройки" onclick="showSettings()">
                <i class="fas fa-cog"></i>
            </div>
        </div>

        <!-- КНОПКА МЕНЮ ДЛЯ МОБИЛЬНОЙ ВЕРСИИ -->
        <div class="mobile-menu-btn" onclick="toggleSidebar()">
            <i class="fas fa-bars"></i>
        </div>

        <!-- САЙДБАР С ЧАТАМИ -->
        <div class="sidebar" id="sidebar">
            <!-- ШАПКА САЙДБАРА -->
            <div class="sidebar-header">
                <div class="user-profile" onclick="showProfileModal()">
                    <div class="user-avatar" id="userAvatar">
                        <!-- Аватар загрузится через JS -->
                    </div>
                    <div class="user-info">
                        <div class="user-name" id="userName">Загрузка...</div>
                        <div class="user-online">
                            <i class="fas fa-circle" style="color: #4CAF50; font-size: 8px;"></i>
                            <span id="userStatus">онлайн</span>
                        </div>
                    </div>
                </div>
                <div class="chat-action-btn" title="Новый чат" onclick="startNewChat()">
                    <i class="fas fa-edit"></i>
                </div>
            </div>

            <!-- ПОИСК -->
            <div class="search-container">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" class="search-input" placeholder="Поиск" id="searchInput" oninput="searchChats()">
                </div>
            </div>

            <!-- СПИСОК ЧАТОВ -->
            <div class="chat-list" id="chatList">
                <!-- ЧАТЫ БУДУТ ДОБАВЛЯТЬСЯ ЗДЕСЬ -->
            </div>

            <!-- КАНАЛЫ (скрыто по умолчанию) -->
            <div class="chat-list hidden" id="channelList">
                <!-- КАНАЛЫ БУДУТ ДОБАВЛЯТЬСЯ ЗДЕСЬ -->
            </div>
        </div>

        <!-- ОСНОВНОЙ ЧАТ -->
        <div class="main-chat">
            <!-- ШАПКА ЧАТА -->
            <div class="chat-header-main">
                <div class="chat-contact">
                    <div class="user-avatar" id="currentChatAvatar">
                        <!-- Аватар чата загрузится через JS -->
                    </div>
                    <div class="chat-contact-info">
                        <div class="chat-contact-name" id="currentChatName">Выберите чат</div>
                        <div class="chat-contact-status" id="currentChatStatus">
                            <!-- Статус загрузится через JS -->
                        </div>
                    </div>
                </div>
                <div class="chat-actions">
                    <div class="chat-action-btn" title="Видеозвонок" onclick="startVideoCall()" id="videoCallBtn" style="display: none;">
                        <i class="fas fa-video"></i>
                    </div>
                </div>
            </div>

            <!-- СООБЩЕНИЯ -->
            <div class="messages-container" id="messagesContainer">
                <div class="message-date">
                    <span class="date-label">Выберите чат для начала общения</span>
                </div>
            </div>

            <!-- ВВОД СООБЩЕНИЙ -->
            <div class="message-input-container" id="messageInputContainer" style="display: none;">
                <div class="input-actions">
                    <div class="input-action-btn" title="Прикрепить файл" onclick="attachFile()">
                        <i class="fas fa-paperclip"></i>
                    </div>
                </div>
                <div class="message-input-wrapper">
                    <textarea class="message-input" placeholder="Сообщение" rows="1" id="messageInput"></textarea>
                </div>
                <button class="send-button" title="Отправить" onclick="sendMessage()">
                    <i class="fas fa-paper-plane"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ВИДЕОЗВОНОК -->
    <div class="call-overlay" id="callOverlay">
        <div class="call-container">
            <div class="call-info">
                <div class="call-name" id="callContactName">Соединение...</div>
                <div class="call-status" id="callStatus">Установка соединения...</div>
            </div>
            <video class="remote-video" id="remoteVideo" autoplay playsinline></video>
            <video class="local-video" id="localVideo" autoplay playsinline muted></video>
            <div class="call-controls">
                <button class="call-btn" id="toggleAudioBtn" onclick="toggleAudio()">
                    <i class="fas fa-microphone"></i>
                </button>
                <button class="call-btn" id="toggleVideoBtn" onclick="toggleVideo()">
                    <i class="fas fa-video"></i>
                </button>
                <button class="call-btn end-call" onclick="endCall()">
                    <i class="fas fa-phone-slash"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- МОДАЛЬНОЕ ОКНО ПРОФИЛЯ -->
    <div class="modal-overlay" id="profileModal">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Редактировать профиль</div>
                <div class="modal-close" onclick="hideProfileModal()">×</div>
            </div>
            
            <div class="avatar-upload">
                <div class="avatar-preview" id="avatarPreview" onclick="triggerAvatarUpload()">
                    <!-- Аватар будет загружен через JS -->
                    <div class="avatar-change">Изменить</div>
                </div>
                <input type="file" id="avatarInput" accept="image/*" style="display: none;" onchange="handleAvatarUpload(event)">
            </div>
            
            <div class="form-group">
                <label class="form-label">Имя</label>
                <input type="text" class="form-input" id="profileName" placeholder="Введите ваше имя">
            </div>
            
            <div class="form-group">
                <label class="form-label">Статус</label>
                <input type="text" class="form-input" id="profileStatus" placeholder="Введите ваш статус">
            </div>
            
            <div class="modal-actions">
                <button class="modal-btn modal-btn-secondary" onclick="hideProfileModal()">
                    Отмена
                </button>
                <button class="modal-btn modal-btn-primary" onclick="saveProfile()">
                    Сохранить
                </button>
            </div>
        </div>
    </div>

    <!-- ПАНЕЛЬ НАСТРОЕК -->
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <div class="settings-title">Настройки</div>
            <div class="settings-close" onclick="hideSettings()">×</div>
        </div>
        <div class="settings-content">
            <div class="settings-section">
                <div class="settings-section-title">Аккаунт</div>
                <div class="setting-item" onclick="showProfileModal()">
                    <div class="setting-label">Изменить профиль</div>
                    <div class="setting-desc">Имя, фото, статус</div>
                </div>
                <div class="setting-item" onclick="changePassword()">
                    <div class="setting-label">Изменить пароль</div>
                    <div class="setting-desc">Безопасность аккаунта</div>
                </div>
            </div>
            
            <div class="settings-section">
                <div class="setting-item" onclick="logout()" style="background: #ff3b30; color: white;">
                    <div class="setting-label">Выйти</div>
                    <div class="setting-desc">Завершить сеанс</div>
                </div>
            </div>
        </div>
    </div>

    <!-- УВЕДОМЛЕНИЕ -->
    <div class="notification" id="notification">
        <div class="notification-header">
            <div class="notification-title" id="notificationTitle">Telegram</div>
            <div class="notification-close" onclick="hideNotification()">×</div>
        </div>
        <div class="notification-body" id="notificationBody">Сообщение</div>
    </div>

    <script>
        // ==================== КОНФИГУРАЦИЯ ====================
        const API_BASE_URL = window.location.hostname === 'localhost' ? 
            'http://localhost:3000/api' : '/api';
        const WS_URL = window.location.hostname === 'localhost' ?
            'ws://localhost:3000' : `wss://${window.location.host}`;

        // ==================== ГЛОБАЛЬНЫЕ ПЕРЕМЕННЫЕ ====================
        let currentUser = null;
        let currentChat = null;
        let chats = [];
        let socket = null;
        let localStream = null;
        let isCallActive = false;
        let isAudioMuted = false;
        let isVideoOff = false;

        // ==================== ИНИЦИАЛИЗАЦИЯ ====================
        document.addEventListener('DOMContentLoaded', async function() {
            // Проверяем токен авторизации
            const token = localStorage.getItem('token');
            if (token) {
                try {
                    showLoading();
                    const user = await verifyToken(token);
                    if (user) {
                        completeLogin(user, token);
                        return;
                    }
                } catch (error) {
                    console.error('Ошибка проверки токена:', error);
                }
            }
            showAuthScreen();
        });

        // ==================== АВТОРИЗАЦИЯ ====================
        async function verifyToken(token) {
            try {
                const response = await fetch(`${API_BASE_URL}/auth/verify`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    return await response.json();
                }
                return null;
            } catch (error) {
                console.error('Ошибка верификации токена:', error);
                return null;
            }
        }

        function showAuthScreen() {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('loading').classList.add('hidden');
        }

        function showLoading() {
            document.getElementById('loading').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loading').classList.add('hidden');
        }

        function showLoginForm() {
            document.getElementById('loginForm').classList.add('active');
            document.getElementById('registerForm').classList.remove('active');
            document.querySelectorAll('.auth-tab').forEach((tab, index) => {
                tab.classList.toggle('active', index === 0);
            });
            clearErrors();
        }

        function showRegisterForm() {
            document.getElementById('loginForm').classList.remove('active');
            document.getElementById('registerForm').classList.add('active');
            document.querySelectorAll('.auth-tab').forEach((tab, index) => {
                tab.classList.toggle('active', index === 1);
            });
            clearErrors();
        }

        function clearErrors() {
            document.getElementById('loginError').classList.remove('active');
            document.getElementById('registerError').classList.remove('active');
        }

        async function login(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            if (!username || !password) {
                showError('loginError', 'Заполните все поля');
                return false;
            }

            showLoading();
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    completeLogin(data.user, data.token);
                } else {
                    hideLoading();
                    showError('loginError', data.message || 'Ошибка авторизации');
                }
            } catch (error) {
                hideLoading();
                showError('loginError', 'Ошибка соединения с сервером');
            }
            
            return false;
        }

        async function register(event) {
            event.preventDefault();
            
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const name = document.getElementById('registerName').value.trim();
            const password = document.getElementById('registerPassword').value;
            const passwordConfirm = document.getElementById('registerPasswordConfirm').value;
            
            // Валидация
            if (!username || !email || !name || !password) {
                showError('registerError', 'Заполните все поля');
                return false;
            }
            
            if (password.length < 6) {
                showError('registerError', 'Пароль должен быть не менее 6 символов');
                return false;
            }
            
            if (password !== passwordConfirm) {
                showError('registerError', 'Пароли не совпадают');
                return false;
            }
            
            if (username.length < 3) {
                showError('registerError', 'Имя пользователя должно быть не менее 3 символов');
                return false;
            }

            showLoading();
            
            try {
                const response = await fetch(`${API_BASE_URL}/auth/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        username,
                        email,
                        name,
                        password
                    })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    completeLogin(data.user, data.token);
                } else {
                    hideLoading();
                    showError('registerError', data.message || 'Ошибка регистрации');
                }
            } catch (error) {
                hideLoading();
                showError('registerError', 'Ошибка соединения с сервером');
            }
            
            return false;
        }

        function completeLogin(user, token) {
            currentUser = user;
            
            // Сохраняем токен
            localStorage.setItem('token', token);
            localStorage.setItem('user', JSON.stringify(user));
            
            // Показываем главный экран
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('appContainer').classList.remove('hidden');
            hideLoading();
            
            // Инициализируем интерфейс
            updateUserProfile();
            loadUserChats();
            connectWebSocket();
            
            showNotification(`Добро пожаловать, ${user.name}!`, 'success');
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.add('active');
        }

        // ==================== WEB SOCKET ====================
        function connectWebSocket() {
            const token = localStorage.getItem('token');
            socket = new WebSocket(`${WS_URL}?token=${token}`);
            
            socket.onopen = function() {
                console.log('WebSocket подключен');
                showNotification('Соединение установлено', 'success');
            };
            
            socket.onmessage = function(event) {
                const data = JSON.parse(event.data);
                handleWebSocketMessage(data);
            };
            
            socket.onclose = function() {
                console.log('WebSocket отключен');
                // Пытаемся переподключиться через 5 секунд
                setTimeout(connectWebSocket, 5000);
            };
            
            socket.onerror = function(error) {
                console.error('WebSocket ошибка:', error);
            };
        }

        function handleWebSocketMessage(data) {
            switch (data.type) {
                case 'new_message':
                    handleNewMessage(data.message);
                    break;
                case 'message_read':
                    handleMessageRead(data.chatId, data.messageIds);
                    break;
                case 'user_status':
                    handleUserStatus(data.userId, data.status);
                    break;
                case 'new_chat':
                    handleNewChat(data.chat);
                    break;
            }
        }

        function handleNewMessage(message) {
            if (currentChat && message.chatId === currentChat._id) {
                addMessageToUI(message);
                chatSystem.markMessagesAsRead(currentChat._id, currentUser._id);
            } else {
                // Обновляем список чатов
                loadUserChats();
                showNotification(`Новое сообщение от ${message.sender.name}`, 'info');
            }
        }

        function handleMessageRead(chatId, messageIds) {
            if (currentChat && currentChat._id === chatId) {
                // Обновляем статус сообщений в UI
                messageIds.forEach(msgId => {
                    const msgElement = document.querySelector(`[data-message-id="${msgId}"]`);
                    if (msgElement) {
                        const checkIcon = msgElement.querySelector('.fa-check');
                        if (checkIcon) {
                            checkIcon.classList.add('fa-check-double');
                        }
                    }
                });
            }
        }

        function handleUserStatus(userId, status) {
            // Обновляем статус в UI
            if (currentChat && currentChat.participants.some(p => p._id === userId)) {
                updateChatUI();
            }
            loadUserChats();
        }

        function handleNewChat(chat) {
            chats.push(chat);
            loadUserChats();
        }

        // ==================== ОСНОВНОЙ ИНТЕРФЕЙС ====================
        function updateUserProfile() {
            if (!currentUser) return;
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userStatus').textContent = currentUser.status || 'онлайн';
            
            const avatarElement = document.getElementById('userAvatar');
            if (currentUser.avatar) {
                avatarElement.innerHTML = `<img src="/uploads/${currentUser.avatar}" alt="${currentUser.name}">`;
            } else {
                avatarElement.innerHTML = getInitials(currentUser.name);
                avatarElement.style.background = getAvatarColor(currentUser._id);
            }
            
            // Для модального окна профиля
            document.getElementById('profileName').value = currentUser.name;
            document.getElementById('profileStatus').value = currentUser.status || '';
            
            const avatarPreview = document.getElementById('avatarPreview');
            if (currentUser.avatar) {
                avatarPreview.innerHTML = `<img src="/uploads/${currentUser.avatar}" alt="${currentUser.name}">`;
            } else {
                avatarPreview.innerHTML = getInitials(currentUser.name);
                avatarPreview.style.background = getAvatarColor(currentUser._id);
            }
        }

        function getInitials(name) {
            return name.split(' ')
                .map(word => word[0])
                .join('')
                .toUpperCase()
                .substring(0, 2);
        }

        function getAvatarColor(id) {
            const colors = [
                'linear-gradient(135deg, #667eea, #764ba2)',
                'linear-gradient(135deg, #4CAF50, #8BC34A)',
                'linear-gradient(135deg, #FF5722, #FF9800)',
                'linear-gradient(135deg, #2196F3, #03A9F4)',
                'linear-gradient(135deg, #E91E63, #9C27B0)'
            ];
            
            // Простое преобразование строки в число
            let hash = 0;
            for (let i = 0; i < id.length; i++) {
                hash = id.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash) % colors.length;
            return colors[index];
        }

        async function loadUserChats() {
            if (!currentUser) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/chats`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    chats = await response.json();
                    renderChatList();
                    updateUnreadBadge();
                }
            } catch (error) {
                console.error('Ошибка загрузки чатов:', error);
            }
        }

        function renderChatList() {
            const chatList = document.getElementById('chatList');
            chatList.innerHTML = '';
            
            // Сортируем чаты по последнему сообщению
            chats.sort((a, b) => new Date(b.lastMessageAt) - new Date(a.lastMessageAt));
            
            chats.forEach(chat => {
                const chatItem = createChatItem(chat);
                chatList.appendChild(chatItem);
            });
        }

        function createChatItem(chat) {
            const chatItem = document.createElement('div');
            chatItem.className = 'chat-item';
            
            if (currentChat && chat._id === currentChat._id) {
                chatItem.classList.add('active');
            }
            
            const chatInfo = getChatInfo(chat);
            const unreadCount = getUnreadCount(chat);
            
            chatItem.innerHTML = `
                <div class="chat-avatar">
                    <div class="chat-avatar-img" style="background: ${chatInfo.avatarColor}">
                        ${chatInfo.avatar}
                    </div>
                    ${chatInfo.isOnline ? '<div class="chat-status"></div>' : ''}
                </div>
                <div class="chat-info">
                    <div class="chat-header">
                        <div class="chat-name">${chatInfo.name}</div>
                        <div class="chat-time">${formatTime(chat.lastMessageAt)}</div>
                    </div>
                    <div class="chat-preview">
                        <div class="chat-preview-text">${getLastMessagePreview(chat)}</div>
                        ${unreadCount > 0 ? `<div class="chat-unread">${unreadCount}</div>` : ''}
                    </div>
                </div>
            `;
            
            chatItem.onclick = () => selectChat(chat);
            return chatItem;
        }

        function getChatInfo(chat) {
            if (chat.type === 'group' || chat.type === 'channel') {
                return {
                    name: chat.name,
                    avatar: chat.avatar ? `<img src="/uploads/${chat.avatar}" alt="${chat.name}">` : getInitials(chat.name),
                    avatarColor: getAvatarColor(chat._id),
                    isOnline: false,
                    id: chat._id
                };
            } else {
                // Для приватного чата находим собеседника
                const otherUser = chat.participants.find(p => p._id !== currentUser._id);
                if (otherUser) {
                    return {
                        name: otherUser.name,
                        avatar: otherUser.avatar ? `<img src="/uploads/${otherUser.avatar}" alt="${otherUser.name}">` : getInitials(otherUser.name),
                        avatarColor: getAvatarColor(otherUser._id),
                        isOnline: otherUser.isOnline || false,
                        id: otherUser._id
                    };
                }
            }
            
            return {
                name: 'Неизвестный',
                avatar: '?',
                avatarColor: getAvatarColor('unknown'),
                isOnline: false,
                id: 'unknown'
            };
        }

        function getLastMessagePreview(chat) {
            if (!chat.lastMessage) {
                return 'Нет сообщений';
            }
            
            const isFromCurrentUser = chat.lastMessage.sender._id === currentUser._id;
            const prefix = isFromCurrentUser ? 'Вы: ' : '';
            const messageText = chat.lastMessage.text || 'Вложение';
            
            return prefix + (messageText.length > 30 
                ? messageText.substring(0, 30) + '...' 
                : messageText);
        }

        function getUnreadCount(chat) {
            if (!chat.unreadCount) return 0;
            return chat.unreadCount[currentUser._id] || 0;
        }

        function formatTime(dateString) {
            if (!dateString) return '';
            
            const date = new Date(dateString);
            const now = new Date();
            const diff = now - date;
            
            if (diff < 24 * 60 * 60 * 1000) {
                // Сегодня
                return date.toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' });
            } else if (diff < 7 * 24 * 60 * 60 * 1000) {
                // На этой неделе
                const days = ['Вс', 'Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб'];
                return days[date.getDay()];
            } else {
                // Ранее
                return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'short' });
            }
        }

        async function selectChat(chat) {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/chats/${chat._id}/messages`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const messages = await response.json();
                    chat.messages = messages;
                    currentChat = chat;
                    
                    // Обновляем UI
                    updateChatUI();
                    loadMessages();
                    
                    // Показываем поле ввода
                    document.getElementById('messageInputContainer').style.display = 'flex';
                    document.getElementById('videoCallBtn').style.display = 'flex';
                    
                    // Отмечаем сообщения как прочитанные
                    markMessagesAsRead();
                    
                    // Обновляем список чатов
                    loadUserChats();
                    
                    // На мобильных устройствах скрываем сайдбар
                    if (window.innerWidth <= 768) {
                        document.getElementById('sidebar').classList.remove('active');
                    }
                }
            } catch (error) {
                console.error('Ошибка загрузки сообщений:', error);
                showNotification('Ошибка загрузки чата', 'error');
            }
        }

        function updateChatUI() {
            if (!currentChat) return;
            
            const chatInfo = getChatInfo(currentChat);
            
            document.getElementById('currentChatName').textContent = chatInfo.name;
            document.getElementById('currentChatAvatar').innerHTML = `
                <div class="chat-avatar-img" style="background: ${chatInfo.avatarColor}">
                    ${chatInfo.avatar}
                </div>
            `;
            
            const statusText = chatInfo.isOnline ? 'в сети' : 'был(а) недавно';
            const statusHtml = chatInfo.isOnline 
                ? '<span class="online-indicator"></span> в сети'
                : `<span style="color: #8a8a8a;">${statusText}</span>`;
            
            document.getElementById('currentChatStatus').innerHTML = statusHtml;
            document.getElementById('callContactName').textContent = chatInfo.name;
        }

        function loadMessages() {
            if (!currentChat || !currentChat.messages) return;
            
            const container = document.getElementById('messagesContainer');
            container.innerHTML = '';
            
            // Группируем сообщения по датам
            let currentDate = null;
            
            currentChat.messages.forEach(msg => {
                const messageDate = new Date(msg.createdAt).toDateString();
                
                if (currentDate !== messageDate) {
                    currentDate = messageDate;
                    const dateDiv = document.createElement('div');
                    dateDiv.className = 'message-date';
                    dateDiv.innerHTML = `<span class="date-label">${formatDate(msg.createdAt)}</span>`;
                    container.appendChild(dateDiv);
                }
                
                addMessageToUI(msg, false);
            });
            
            // Прокручиваем вниз
            container.scrollTop = container.scrollHeight;
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            
            if (date.toDateString() === now.toDateString()) {
                return 'Сегодня';
            }
            
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            if (date.toDateString() === yesterday.toDateString()) {
                return 'Вчера';
            }
            
            return date.toLocaleDateString('ru-RU', {
                day: 'numeric',
                month: 'long',
                year: 'numeric'
            });
        }

        function addMessageToUI(message, scroll = true) {
            if (!currentChat) return;
            
            const container = document.getElementById('messagesContainer');
            const isOutgoing = message.sender._id === currentUser._id;
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${isOutgoing ? 'outgoing' : 'incoming'}`;
            messageDiv.setAttribute('data-message-id', message._id);
            
            const sender = message.sender;
            const senderName = sender ? sender.name : 'Неизвестный';
            
            let messageHtml = `
                <div class="message-bubble">${message.text}</div>
                <div class="message-time">${formatTime(message.createdAt)}`;
            
            if (isOutgoing) {
                messageHtml += ` <i class="fas fa-check${message.readBy && message.readBy.length > 0 ? '-double' : ''}" 
                    style="color: ${message.readBy && message.readBy.length > 0 ? '#4CAF50' : '#8a8a8a'};"></i>`;
            }
            
            messageHtml += `</div>`;
            messageDiv.innerHTML = messageHtml;
            
            container.appendChild(messageDiv);
            
            if (scroll) {
                container.scrollTop = container.scrollHeight;
            }
        }

        // ==================== СООБЩЕНИЯ ====================
        async function sendMessage() {
            if (!currentChat || !currentUser) return;
            
            const input = document.getElementById('messageInput');
            const text = input.value.trim();
            
            if (!text) return;
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/chats/${currentChat._id}/messages`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ text })
                });
                
                if (response.ok) {
                    const message = await response.json();
                    
                    // Добавляем в UI
                    addMessageToUI(message);
                    
                    // Обновляем список чатов
                    loadUserChats();
                    
                    // Очищаем поле ввода
                    input.value = '';
                    adjustTextareaHeight(input);
                }
            } catch (error) {
                console.error('Ошибка отправки сообщения:', error);
                showNotification('Ошибка отправки сообщения', 'error');
            }
        }

        async function markMessagesAsRead() {
            if (!currentChat) return;
            
            try {
                const token = localStorage.getItem('token');
                await fetch(`${API_BASE_URL}/chats/${currentChat._id}/read`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                // Обновляем список чатов
                loadUserChats();
            } catch (error) {
                console.error('Ошибка отметки сообщений как прочитанных:', error);
            }
        }

        // ==================== ВИДЕОЗВОНКИ ====================
        async function startVideoCall() {
            if (!currentChat || !currentUser) {
                showNotification('Выберите чат для звонка', 'error');
                return;
            }

            try {
                showNotification('Запуск видеозвонка...', 'info');
                
                // Показываем экран звонка
                document.getElementById('callOverlay').classList.add('active');
                document.getElementById('callStatus').textContent = 'Запрос доступа к камере...';

                // Запрашиваем доступ к медиаустройствам
                localStream = await navigator.mediaDevices.getUserMedia({
                    video: {
                        width: { ideal: 1280 },
                        height: { ideal: 720 },
                        facingMode: 'user'
                    },
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 44100
                    }
                });

                // Показываем локальное видео
                const localVideo = document.getElementById('localVideo');
                localVideo.srcObject = localStream;

                // Обновляем статус
                document.getElementById('callStatus').textContent = 'Соединение установлено';
                isCallActive = true;

                // Симуляция ответа от другого устройства
                setTimeout(() => {
                    if (isCallActive) {
                        simulateRemoteVideo();
                        showNotification('Соединение установлено', 'success');
                    }
                }, 2000);

            } catch (error) {
                console.error('Ошибка звонка:', error);
                document.getElementById('callStatus').textContent = 'Ошибка: нет доступа к камере';
                showNotification('Разрешите доступ к камере и микрофону', 'error');
                
                setTimeout(() => {
                    endCall();
                }, 3000);
            }
        }

        function simulateRemoteVideo() {
            const remoteVideo = document.getElementById('remoteVideo');
            
            // Создаем тестовое видео
            const canvas = document.createElement('canvas');
            canvas.width = 640;
            canvas.height = 480;
            const ctx = canvas.getContext('2d');

            // Анимация для имитации видео
            function drawFrame() {
                if (!isCallActive) return;

                // Градиентный фон
                const gradient = ctx.createLinearGradient(0, 0, canvas.width, canvas.height);
                gradient.addColorStop(0, '#667eea');
                gradient.addColorStop(1, '#764ba2');
                ctx.fillStyle = gradient;
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Имя пользователя
                ctx.fillStyle = 'white';
                ctx.font = '48px Arial';
                ctx.textAlign = 'center';
                
                const chatInfo = getChatInfo(currentChat);
                const initials = chatInfo.avatar.replace(/<[^>]*>/g, '');
                ctx.fillText(initials, canvas.width/2, canvas.height/2);

                // Преобразуем canvas в stream
                const stream = canvas.captureStream(30);
                remoteVideo.srcObject = stream;

                requestAnimationFrame(drawFrame);
            }

            drawFrame();
        }

        function toggleAudio() {
            if (localStream) {
                const audioTrack = localStream.getAudioTracks()[0];
                if (audioTrack) {
                    audioTrack.enabled = !audioTrack.enabled;
                    isAudioMuted = !audioTrack.enabled;
                    
                    const btn = document.getElementById('toggleAudioBtn');
                    if (isAudioMuted) {
                        btn.classList.add('muted');
                        btn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                        showNotification('Микрофон выключен', 'info');
                    } else {
                        btn.classList.remove('muted');
                        btn.innerHTML = '<i class="fas fa-microphone"></i>';
                        showNotification('Микрофон включен', 'info');
                    }
                }
            }
        }

        function toggleVideo() {
            if (localStream) {
                const videoTrack = localStream.getVideoTracks()[0];
                if (videoTrack) {
                    videoTrack.enabled = !videoTrack.enabled;
                    isVideoOff = !videoTrack.enabled;
                    
                    const btn = document.getElementById('toggleVideoBtn');
                    if (isVideoOff) {
                        btn.classList.add('muted');
                        btn.innerHTML = '<i class="fas fa-video-slash"></i>';
                        showNotification('Камера выключена', 'info');
                    } else {
                        btn.classList.remove('muted');
                        btn.innerHTML = '<i class="fas fa-video"></i>';
                        showNotification('Камера включена', 'info');
                    }
                }
            }
        }

        function endCall() {
            isCallActive = false;
            
            // Останавливаем медиапотоки
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
                localStream = null;
            }
            
            // Очищаем видео
            document.getElementById('localVideo').srcObject = null;
            document.getElementById('remoteVideo').srcObject = null;
            
            // Скрываем экран звонка
            document.getElementById('callOverlay').classList.remove('active');
            
            // Сбрасываем состояние
            isAudioMuted = false;
            isVideoOff = false;
            
            // Обновляем кнопки
            const audioBtn = document.getElementById('toggleAudioBtn');
            const videoBtn = document.getElementById('toggleVideoBtn');
            audioBtn.classList.remove('muted');
            audioBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            videoBtn.classList.remove('muted');
            videoBtn.innerHTML = '<i class="fas fa-video"></i>';
            
            showNotification('Звонок завершен', 'info');
        }

        // ==================== ПРОФИЛЬ ====================
        function showProfileModal() {
            document.getElementById('profileModal').classList.add('active');
        }

        function hideProfileModal() {
            document.getElementById('profileModal').classList.remove('active');
        }

        function triggerAvatarUpload() {
            document.getElementById('avatarInput').click();
        }

        async function handleAvatarUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('image/')) {
                showNotification('Пожалуйста, выберите изображение', 'error');
                return;
            }
            
            if (file.size > 5 * 1024 * 1024) {
                showNotification('Изображение должно быть меньше 5MB', 'error');
                return;
            }
            
            const formData = new FormData();
            formData.append('avatar', file);
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/users/avatar`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    },
                    body: formData
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser.avatar = data.avatar;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    updateUserProfile();
                    showNotification('Аватар обновлен', 'success');
                }
            } catch (error) {
                showNotification('Ошибка загрузки аватара', 'error');
            }
        }

        async function saveProfile() {
            const name = document.getElementById('profileName').value.trim();
            const status = document.getElementById('profileStatus').value.trim();
            
            if (!name) {
                showNotification('Введите имя', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/users/profile`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        name,
                        status
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    localStorage.setItem('user', JSON.stringify(currentUser));
                    
                    // Обновляем UI
                    updateUserProfile();
                    loadUserChats();
                    
                    // Закрываем модальное окно
                    hideProfileModal();
                    
                    showNotification('Профиль обновлен', 'success');
                }
            } catch (error) {
                showNotification('Ошибка обновления профиля', 'error');
            }
        }

        // ==================== НАСТРОЙКИ ====================
        function showSettings() {
            document.getElementById('settingsPanel').classList.add('active');
        }

        function hideSettings() {
            document.getElementById('settingsPanel').classList.remove('active');
        }

        async function changePassword() {
            const oldPassword = prompt('Введите текущий пароль:');
            if (!oldPassword) return;
            
            const newPassword = prompt('Введите новый пароль:');
            if (!newPassword) return;
            
            if (newPassword.length < 6) {
                showNotification('Пароль должен быть не менее 6 символов', 'error');
                return;
            }
            
            const confirmPassword = prompt('Повторите новый пароль:');
            if (newPassword !== confirmPassword) {
                showNotification('Пароли не совпадают', 'error');
                return;
            }
            
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/users/password`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({
                        oldPassword,
                        newPassword
                    })
                });
                
                if (response.ok) {
                    showNotification('Пароль изменен', 'success');
                } else {
                    const data = await response.json();
                    showNotification(data.message || 'Ошибка изменения пароля', 'error');
                }
            } catch (error) {
                showNotification('Ошибка изменения пароля', 'error');
            }
        }

        function logout() {
            if (confirm('Выйти из аккаунта?')) {
                // Очищаем локальное хранилище
                localStorage.removeItem('token');
                localStorage.removeItem('user');
                
                // Закрываем WebSocket соединение
                if (socket) {
                    socket.close();
                }
                
                // Перезагружаем страницу
                location.reload();
            }
        }

        // ==================== ВСПОМОГАТЕЛЬНЫЕ ФУНКЦИИ ====================
        function showChats() {
            document.getElementById('chatList').classList.remove('hidden');
            document.getElementById('channelList').classList.add('hidden');
            updateMenuActive('chats');
        }

        function showChannels() {
            document.getElementById('chatList').classList.add('hidden');
            document.getElementById('channelList').classList.remove('hidden');
            updateMenuActive('channels');
            renderChannels();
        }

        async function renderChannels() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/channels`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const channels = await response.json();
                    const channelList = document.getElementById('channelList');
                    channelList.innerHTML = '';
                    
                    channels.forEach(channel => {
                        const channelItem = document.createElement('div');
                        channelItem.className = 'channel-item';
                        
                        channelItem.innerHTML = `
                            <div class="channel-avatar" style="background: ${getAvatarColor(channel._id)}">
                                ${channel.avatar ? `<img src="/uploads/${channel.avatar}" alt="${channel.name}">` : getInitials(channel.name)}
                            </div>
                            <div class="chat-info">
                                <div class="chat-header">
                                    <div class="chat-name">${channel.name}</div>
                                    <div class="chat-time">${formatTime(channel.lastMessageAt)}</div>
                                </div>
                                <div class="chat-preview">
                                    <div class="chat-preview-text">${channel.description || 'Нет описания'}</div>
                                    <div class="chat-unread">${channel.subscribers || 0}</div>
                                </div>
                            </div>
                        `;
                        
                        channelList.appendChild(channelItem);
                    });
                }
            } catch (error) {
                console.error('Ошибка загрузки каналов:', error);
            }
        }

        function updateMenuActive(activeItem) {
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });
            
            const items = {
                'chats': 0,
                'channels': 1,
                'settings': 2
            };
            
            if (items[activeItem] !== undefined) {
                document.querySelectorAll('.menu-item')[items[activeItem]].classList.add('active');
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('active');
        }

        function searchChats() {
            const query = document.getElementById('searchInput').value.toLowerCase();
            const chatItems = document.querySelectorAll('.chat-item');
            
            chatItems.forEach(item => {
                const chatName = item.querySelector('.chat-name').textContent.toLowerCase();
                if (chatName.includes(query)) {
                    item.style.display = 'flex';
                } else {
                    item.style.display = 'none';
                }
            });
        }

        async function startNewChat() {
            try {
                const token = localStorage.getItem('token');
                const response = await fetch(`${API_BASE_URL}/users`, {
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                if (response.ok) {
                    const users = await response.json();
                    // Фильтруем текущего пользователя и уже имеющиеся чаты
                    const availableUsers = users.filter(user => 
                        user._id !== currentUser._id && 
                        !chats.some(chat => 
                            chat.type === 'private' && 
                            chat.participants.some(p => p._id === user._id)
                        )
                    );
                    
                    if (availableUsers.length === 0) {
                        showNotification('Нет доступных пользователей для нового чата', 'info');
                        return;
                    }
                    
                    // Создаем чат с первым пользователем (в реальном приложении нужно дать выбор)
                    const otherUser = availableUsers[0];
                    
                    const createResponse = await fetch(`${API_BASE_URL}/chats`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${token}`
                        },
                        body: JSON.stringify({
                            type: 'private',
                            participants: [otherUser._id]
                        })
                    });
                    
                    if (createResponse.ok) {
                        const newChat = await createResponse.json();
                        chats.push(newChat);
                        selectChat(newChat);
                        showNotification(`Начат чат с ${otherUser.name}`, 'success');
                    }
                }
            } catch (error) {
                console.error('Ошибка создания чата:', error);
                showNotification('Ошибка создания чата', 'error');
            }
        }

        function attachFile() {
            showNotification('Функция в разработке', 'info');
        }

        function updateUnreadBadge() {
            let totalUnread = 0;
            
            chats.forEach(chat => {
                totalUnread += getUnreadCount(chat);
            });
            
            document.getElementById('unreadBadge').textContent = totalUnread;
        }

        function adjustTextareaHeight(textarea) {
            textarea.style.height = 'auto';
            textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
        }

        // ==================== УВЕДОМЛЕНИЯ ====================
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const title = document.getElementById('notificationTitle');
            const body = document.getElementById('notificationBody');
            
            body.textContent = message;
            
            // Устанавливаем цвет в зависимости от типа
            if (type === 'error') {
                title.innerHTML = '⚠️ Ошибка';
                notification.style.borderLeft = '4px solid #ff3b30';
            } else if (type === 'success') {
                title.innerHTML = '✅ Успешно';
                notification.style.borderLeft = '4px solid #4CAF50';
            } else {
                title.innerHTML = 'ℹ️ Telegram';
                notification.style.borderLeft = '4px solid #0088cc';
            }
            
            notification.classList.add('active');
            
            // Автоматическое скрытие
            setTimeout(() => {
                notification.classList.remove('active');
            }, 3000);
        }

        function hideNotification() {
            document.getElementById('notification').classList.remove('active');
        }

        // ==================== ОБРАБОТЧИКИ СОБЫТИЙ ====================
        function setupEventListeners() {
            // Автоматическое изменение высоты textarea
            const messageInput = document.getElementById('messageInput');
            messageInput.addEventListener('input', function() {
                adjustTextareaHeight(this);
            });

            // Отправка сообщения по Enter (без Shift)
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });

            // Закрытие звонка по Escape
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && isCallActive) {
                    endCall();
                }
            });

            // Адаптация к мобильным устройствам
            window.addEventListener('resize', function() {
                if (window.innerWidth > 768) {
                    document.getElementById('sidebar').classList.remove('active');
                }
            });
        }

        // Инициализация обработчиков событий
        setupEventListeners();
    </script>
</body>
</html>
